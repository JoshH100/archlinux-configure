- name: Post install config 
  hosts: all 
  strategy: free
  gather_facts: True
  vars:
    software_remove:
      - jre7-openjdk
      - jre7-openjdk-headless
      - vim
    # label what kind of license servers these are
    license:
      servers:
        - license.mines.edu
        - enable.mines.edu
        - entitle.mines.edu
        - entrust.mines.edu
    pacserve:
      # enable use of this flag
      enabled: false
      args: --multicast --peer http://greyfox.mines.edu:15678
    cups:
      servername: cups.mines.edu
    pacman:
      canary_hosts:
        - bb136-01
        - bb136-23
        - ck182-34
        - ch275l-07
        - grla110-28
      options:
        - UseSyslog
        - Color
        - TotalDownload
        - CheckSpace
        - UseDelta
      preserved_configs:
        - "etc/ssh/sshd_config"
        - "etc/systemd/logind.conf"
      repos:
          - {name: mines2, server: 'http://labbuild-test1.mines.edu:15678/pacman/$repo/$arch' }
          - {name: sublime-text, server: 'https://download.sublimetext.com/arch/stable/x86_64' }
      mirrors:
        - 'https://lug.mines.edu/mirrors/archlinux/$repo/os/$arch'
    brand:
      short: csm
      motd:
        - "Hostname: $(hostname)"
        - "Archlinux kernel version: $(pacman -Q linux)"
        - "Send software/package requests to helpdesk@mines.edu"
    system:
      locales:
        - en_US.UTF-8
        - en_DK.UTF-8 # en_DK for real l88t users respecing iso8601
    ssh1:
      ceys: # keys breaks ansible :)
        - {user: root, key: !unsafe 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDO2AP8dIYfX45Ls+FsmlZjEz2XRy1gQTHpvVkPgeFehOmpDiZCR3XIkTLGpt+YSEpHVp9Knl3o6NZBv4z+g9ScS36s0ithAWEeIpLEwSD5lIrmUU2NCdXsbSucR29d6UlyexwCmSJ+qcPxS1HmFzYBG+59z/PT3eXyOgeSeGmz0g5fuAgj0eptnd/0oSAz/kdwM9qMR2MHg0ViREcxanjSnztjFiZkBIyqTDfYaFcpMAkXpW/xeis3JHZLFIqSNBEQEhSc3A+mriR894IfnyudPTldziRGTI0oY2qAOCZ4okMw4lpY4Xnc4krAvPEtRkr6EhE8wpBVeMOW9cJCbMZ1 jhoffer@pizza.mines.edu.'}
    lightdm:
      session-wrapper: /etc/lightdm/Xsession
      session-cleanup: /etc/lightdm/Xcleanup
    ansible:
      userprofile: "ansible-playbook /usr/share/mines-playbooks/archlinux-userprofile/userprofile.yml >> /tmp/ansible.log"
    isdell: true
    sensu:
      rabbitmq:
        host: plabmon.mines.edu
        user: "client"
        password: "sm2JNjS6lhGjKnPFnp5w" 
    zsh:
      theme: clint
      term: linux
      sources:
        - "/usr/share/doc/pkgfile/command-not-found.zsh"
        - "/usr/share/zsh/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"
        - "/etc/zsh/buildfunctions"
        #- "{{ zsh.build.functions.dest }}" # this probably won't work
      build:
        functions:
          src: buildfunctions.j2
          dest: /etc/zsh/buildfunctions
    contact_email: jhoffer@mines.edu
    mines_repo_host: greyfox.mines.edu:15678
    type: lab
    repos:
      mines2:
    sudo:
      groups:
        - ccitlabadmins
    # REMOVE module_list
    module_list:
      - cachefiles
    pacmankeys:
      - {name: "8A8F901A", src: "https://download.sublimetext.com/sublimehq-pub.gpg"}
      - {name: "7448C890582975CD" }
    nfs:
      domain: mines.edu
    kerberos:
      realm: mines.edu
      admin_server: 138.67.138.105
      kdc:
        - 138.67.138.105
        - 138.67.138.106
        - 138.67.138.114
    ldap:
      packages:
        - openldap
        - nss-pam-ldapd
        - sssd
        - pam-krb5
      domain: mines.edu
      uri: "ldaps://ldap.mines.edu"
      searchbase: "dc=mines,dc=edu"
      tlscacert_src: MinesCerts
      tlscacert_dir: "/etc/MinesCerts"
      realm: "MINES.EDU"
      krb5_server: "138.67.138.105,138.67.138.106"
    network:
      domains: adit.mines.edu mines.edu
      config:
        - 25-wired.network
      smb_share:
        name: zdrive
        domain: ADIT
        path: "hornet-ct.mines.edu/Users/${USER:0:1}/${USER}"
        share: users
        src: '$XDG_RUNTIME_DIR/gvfs/smb-share:domain=ADIT,server=hornet-ct.mines.edu,share=users,user=${USER}/${USER:0:1}/${USER}'
        dst: "$HOME/zdrive"
        inst: /usr/local/bin/zdrive
        desktop_entry:
          comment: Mount ADIT Z Drive
          categories: "GNOME;GTK;Utility;Core;Mines"
    mounts:
      home:
        share: files.mines.edu:/export/fermat
        mount: /u 
        type: nfs
        options: auto,x-systemd.automount,x-systemd.device-timeout=10,rsize=32768,wsize=32768,nolock,ac,vers=3
        automount: true
      gpfc:
        share: files.mines.edu:/export/gpfc
        mount: /gpfc 
        type: nfs
        options: auto,x-systemd.automount,x-systemd.device-timeout=10,rsize=32768,wsize=32768,nolock,ac,vers=3
        automount: true
      scratch:
        share: files.mines.edu:/export/scratch
        mount: /scratch 
        type: nfs
        options: auto,x-systemd.automount,x-systemd.device-timeout=10,rsize=32768,wsize=32768,nolock,ac,vers=3
        automount: true
  pre_tasks:
    - pacman: update_cache=true
      register: pacman_updated

  roles:
    - {role: common, tags: ['common']}
    - {role: ssh, tags: ['ssh']}
    - {role: system, tags: ['system']}
    - {role: mount, tags: ['mount']}
    - {role: pacman, tags: ['pacman']}
    - {role: sensu , tags: ['sensu']}
    - {role: ldap, tags: ['ldap']}
    - {role: ansible, tags: ['ansible']}
    - {role: root, tags: ['root']}
    # upgrade (software install) takes the longest
    - {role: upgrade, tags: ['upgrade']}
    - {role: bios, tags: ['bios']}
    - {role: secureboot, tags: ['secureboot']}
    - {role: network , tags: ['network']}
    - {role: ldap, tags: ['ldap']}
    - {role: branding, tags: ['branding']}
